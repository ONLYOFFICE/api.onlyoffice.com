name: update-lambda

on:
  push:
    paths:
      - .github/lambda/**
    branches:
      - develop
      - master
  workflow_dispatch: {}

concurrency:
  group: deploy-lambda-${{ github.ref }}
  cancel-in-progress: false
  
jobs:            
  prepare:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.vars.outputs.environment }}
      stack_name:  ${{ steps.vars.outputs.stack_name }}
      alias:       ${{ steps.vars.outputs.alias }}
      aws_region:  ${{ steps.vars.outputs.aws_region }}
      aws_distribution_id: ${{ steps.vars.outputs.aws_distribution_id }}
      aws_access_key: ${{ steps.vars.outputs.aws_access_key }}
      aws_access_key_secret: ${{ steps.vars.outputs.aws_access_key_secret }}
      
    steps:
      - name: Compute environment variables by branch
        id: vars
        env: 
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          if [[ "$BRANCH_NAME" == "master" ]]; then
            echo "Set production environment"
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "stack_name=api-onlyoffice-redirects-prod" >> $GITHUB_OUTPUT
            echo "alias=prod" >> $GITHUB_OUTPUT
            echo "aws_region=us-east-1" >> $GITHUB_OUTPUT
            echo "aws_distribution_id=${{ secrets.AWS_DISTRIBUTION_ID_PROD }}" >> $GITHUB_OUTPUT
            echo "aws_access_key=${{ secrets.AWS_ACCESS_KEY_PROD }}" >> $GITHUB_OUTPUT
            echo "aws_access_key_secret=${{ secrets.AWS_SECRET_KEY_PROD }}" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH_NAME" == "develop" ]]; then
            echo "Set develop environment"
            echo "environment=develop" >> $GITHUB_OUTPUT
            echo "stack_name=api-onlyoffice-redirects-dev" >> $GITHUB_OUTPUT
            echo "alias=develop" >> $GITHUB_OUTPUT
            echo "aws_region=us-east-1" >> $GITHUB_OUTPUT
            echo "aws_distribution_id=${{ secrets.AWS_DISTRIBUTION_ID_TEST }}" >> $GITHUB_OUTPUT
            echo "aws_access_key=${{ secrets.AWS_ACCESS_KEY_TEST }}" >> $GITHUB_OUTPUT
            echo "aws_access_key_secret=${{ secrets.AWS_SECRET_KEY_TEST }}" >> $GITHUB_OUTPUT
          fi
          
  deploy:
    runs-on: ubuntu-latest
    needs: [ prepare ]
    environment: ${{ needs.prepare.outputs.environment }}
    env:
      LAMBDA_CODE_DIR: .github/lambda/src
      SAM_TEMPLATE: .github/lambda/template.yaml
      STACK_NAME: ${{ needs.prepare.outputs.stack_name }}
      LAMBDA_FUNCTION_NAME: "url-rewrite-api-teamlab-info-rewriteUrls-python"
      LAMBDA_ALIAS: ${{ needs.prepare.outputs.alias }}
      AWS_REGION: ${{ needs.prepare.outputs.aws_region }}
      AWS_ACCESS_KEY: ${{ needs.prepare.outputs.aws_access_key }}
      AWS_SECRET_ACCESS_KEY: ${{ needs.prepare.outputs.aws_access_key_secret }}
      AWS_DISTRIBUTION_ID: ${{ needs.prepare.outputs.aws_distribution_id }}
    steps:
    - uses: actions/checkout@v4
    - uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID_PROD }}
        aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY_PROD }}
        aws-region: ${{ env.AWS_REGION_PROD }}
    
    - name: Setup SAM CLI
      uses: aws-actions/setup-sam@v2

    - name: Build (SAM)
      run: |
          sam build --template ${SAM_TEMPLATE}

    - name: Deploy (SAM)
      run: |
          sam deploy \
            --no-confirm-changeset \
            --resolve-s3 \
            --stack-name "${STACK_NAME}" \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              FunctionName=${LAMBDA_FUNCTION_NAME} \
              AliasName=${LAMBDA_ALIAS}

    - name: Resolve new Lambda version from alias
      id: resolve_version
      run: |
        VERSION=$(aws lambda get-alias \
          --function-name "${{ env.LAMBDA_FUNCTION_NAME }}" \
          --name "${{ needs.prepare.outputs.alias }}" \
          --query 'FunctionVersion' --output text)

        BASE_ARN=$(aws lambda get-function \
          --function-name "${{ env.LAMBDA_FUNCTION_NAME }}" \
          --query 'Configuration.FunctionArn' --output text)

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "versioned_arn=${BASE_ARN}:${VERSION}" >> $GITHUB_OUTPUT
      
    - name: Update distribution config
      env:
        VERSIONED_ARN: ${{ steps.resolve_version.outputs.versioned_arn }}
      run: |
          aws cloudfront get-distribution-config --id "$AWS_DISTRIBUTION_ID" --output json > current-distribution-config.json
          
          # backup config
          cp current-distribution-config.json ../cf_config_backup.json
          
          # Get ETAG
          ETAG=$(jq -r '.ETag' < ./current-distribution-config.json)

          # Remove ETAG
          jq -r 'del(.ETag)' ./current-distribution-config.json > tmp.json && mv tmp.json current-distribution-config.json

          # Get config
          jq -r '.DistributionConfig' current-distribution-config.json > dist.json

          jq --arg arn "$VERSIONED_ARN" '
            .DefaultCacheBehavior.LambdaFunctionAssociations.Items
            |= (map(if .EventType=="viewer-request"
                    then .LambdaFunctionARN=$arn else . end))
          ' dist.json > dist-upd.json

          aws cloudfront update-distribution --id "${AWS_DISTRIBUTION_ID}" \
                                             --distribution-config "file://dist-upd.json" \
                                             --if-match "${ETAG}" > /dev/null

