name: update-lambda

on:
  push:
    paths:
      - .github/lambda/**
    branches:
      - develop
      - master
  workflow_dispatch: {}

concurrency:
  group: update-cf-config
  cancel-in-progress: false
  
jobs:                      
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'develop' && 'develop' || 'production' }}
    env:
      LAMBDA_CODE_DIR: .github/lambda/src
      SAM_TEMPLATE: .github/lambda/template.yaml
      LAMBDA_FUNCTION_NAME: "onlyoffice-api-site-url-rewrite"
    steps:
    - uses: actions/checkout@v4
    - name: Compute environment variables by branch
      id: vars
      env: 
        BRANCH_NAME: ${{ github.ref_name }}
      run: |
        if [[ "$BRANCH_NAME" == "master" ]]; then
          echo "Set environment for production"
          echo "STACK_NAME=api-onlyoffice-redirects-prod" >> $GITHUB_ENV
          echo "ALIAS=prod" >> $GITHUB_ENV
          echo "AWS_DISTRIBUTION_ID=${{ secrets.AWS_DISTRIBUTION_ID_PROD }}" >> $GITHUB_ENV
        elif [[ "$BRANCH_NAME" == "develop" ]]; then
          echo "Set environment for Develop"
          echo "STACK_NAME=api-onlyoffice-redirects-dev" >> $GITHUB_ENV
          echo "ALIAS=develop" >> $GITHUB_ENV
          echo "AWS_DISTRIBUTION_ID=${{ secrets.AWS_DISTRIBUTION_ID_TEST }}" >> $GITHUB_ENV
        else
          echo "ERROR: Wrong github.ref_name"
          exit 1
        fi
        
    - uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_LAMBDA_ACCESS_KEY }}
        aws-secret-access-key: ${{ secrets.AWS_LAMBDA_SECRET_KEY }}
        aws-region: us-east-1
    
    - name: Setup SAM CLI
      uses: aws-actions/setup-sam@v2

    - name: Build (SAM)
      id: sam-build
      run: |
          sam build -u --template-file ${SAM_TEMPLATE}

    - name: Deploy (SAM)
      id: sam-deploy
      run: |
          sam deploy \
            --no-confirm-changeset \
            --resolve-s3 \
            --stack-name "${STACK_NAME}" \
            --capabilities CAPABILITY_IAM \
            --template-file ${SAM_TEMPLATE} \
            --role-arn ${{ secrets.CLOUDFORMATION_EXECUTION_ROLE }} \
            --parameter-overrides \
              FunctionName=${LAMBDA_FUNCTION_NAME} \
              AliasName=${ALIAS}
          sleep 10

    - name: Resolve new Lambda version from alias
      id: resolve_version
      run: |
        VERSION=$(aws lambda get-alias \
          --function-name "${LAMBDA_FUNCTION_NAME}" \
          --name "${ALIAS}" \
          --query 'FunctionVersion' --output text)

        BASE_ARN=$(aws lambda get-function \
          --function-name "${LAMBDA_FUNCTION_NAME}" \
          --query 'Configuration.FunctionArn' --output text)

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "versioned_arn=${BASE_ARN}:${VERSION}" >> $GITHUB_OUTPUT
      
    - name: Update distribution config
      id: cfconf
      env:
        VERSIONED_ARN: ${{ steps.resolve_version.outputs.versioned_arn }}
      run: |
          mkdir cf_tmp
          cd ./cf_tmp
          aws cloudfront get-distribution-config --id "$AWS_DISTRIBUTION_ID" --output json > current-distribution-config.json
          
          # backup config
          cp current-distribution-config.json ../cf_config_backup.json
          
          # Get ETAG
          ETAG=$(jq -r '.ETag' < ./current-distribution-config.json)

          # Remove ETAG
          jq -r 'del(.ETag)' ./current-distribution-config.json > tmp.json && mv tmp.json current-distribution-config.json

          # Get config
          jq -r '.DistributionConfig' current-distribution-config.json > dist.json

          jq --arg arn "$VERSIONED_ARN" '
            .DefaultCacheBehavior.LambdaFunctionAssociations.Items
            |= (map(if .EventType=="viewer-request"
                    then .LambdaFunctionARN=$arn else . end))
          ' dist.json > new-distribution-confing.json

          aws cloudfront update-distribution --id "${AWS_DISTRIBUTION_ID}" \
                                             --distribution-config "file://new-distribution-confing.json" \
                                             --if-match "${ETAG}" > /dev/null
    
    - name: Collect statuses
      if: always()
      env:
        SAM_DEPLOY: ${{ steps.sam-deploy.outcome }}
        CF_CONF_STATUS: ${{ steps.cfconf.outcome }}
      run: |
          if [[ "$SAM_DEPLOY" == 'failure' ]]; then
             echo "SAM_DEPLOY==failureðŸ”´" >> $GITHUB_ENV
             echo "CF_CONF_STATUS=skipped" >> $GITHUB_ENV
          fi
          if [[ "$SAM_DEPLOY" == 'success' ]]; then
             echo "SAM_DEPLOY=successðŸŸ¢" >> $GITHUB_ENV
             [[ "$CF_CONF_STATUS" == 'failure' ]] && echo "CF_CONF_STATUS=failureðŸ”´" >> $GITHUB_ENV
             [[ "$CF_CONF_STATUS" == 'success' ]] && echo "CF_CONF_STATUS=successðŸŸ¢" >> $GITHUB_ENV
          fi

    - name: Send alert message
      if: always()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        document: ./cf_config_backup.json
        message: |
            AWS LAMBDA redirects update for env: ${{ env.ALIAS }}
            ${{ github.actor }} created commit:
            Commit message: ${{ github.event.commits[0].message }}

            Repository: ${{ github.repository }}
            Action: ${{ github.event_name }}
            Workflow: ${{ github.workflow }}
            Branch: ${{ github.ref_name }}
            Environment: ${{ env.ALIAS }}

            AWS Lambda deploy status: ${{ env.SAM_DEPLOY }}
            AWS CloudFront config update status: ${{ env.CF_CONF_STATUS }}
